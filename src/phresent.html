<!doctype html>
<html>
  <head>
    <title>Presenter Channel</title>
    <link rel="stylesheet" href="/lib/css/jquery-ui.css">
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      #present {width: 800px; height: 600px; margin: 0 auto; margin-top: -200px}
      #previous {background-image: url(/lib/img/previous.png); display: inline-block; width: 44px; height: 44px; outline: none; text-indent: -9999px; margin-top: 300px;}
      #previous:hover {background-position: 0 -44px;}
      #next {background-image: url(/lib/img/next.png); display: inline-block; width: 44px; height: 44px; outline: none; text-indent: -9999px; float:right; margin-top: -444px;}
      #next:hover {background-position: 0 -44px;}
      #question {position: absolute; top: 1%; right:1%;}
      #number {position: absolute; top: 1%; right: 1%; z-index:9999; font-size: 20px; border: 3px red solid; background-color: white;}
      #vote {position: absolute; bottom: 1%; right: 1%; }
      #placeholder {width: 600px; height: 480px; min-height: 480px; font-size: 14px; line-height: 1.2em;}
      #previous-question {background-image: url(/lib/img/previous.png); display: inline-block; width: 44px; height: 44px; outline: none; text-indent: -9999px; margin-top: 300px;float:left;}
      #previous-question:hover {background-position: 0 -44px;}
      #next-question {background-image: url(/lib/img/next.png); display: inline-block; width: 44px; height: 44px; outline: none; text-indent: -9999px; float:right; margin-top: 300px;}
      #next-question:hover {background-position: 0 -44px;}
      #present-question {min-height:480px; min-width:600px;float:left;}
      #comment-bar {position:absolute; min-height:150px; min-width:100%; bottom:0;background-color: black; color:white;}
      #comment1 {width:100%; height:100%;}
      #comment2 {width:100%; height:100%;}
      #status-bar {width:100%; min-height: 40px;background-color: grey;}
      #connected {float:right; font-size:25px; margin-top: 5px;margin-right:250px;}
      #elapsed-time {float: right; font-size:25px; margin-top: 5px;margin-right: 50px;}
      #left-time {float:right; font-size:25px; margin-top: 5px; margin-right:50px;}

    </style>
    <script src="/lib/js/socket.io-1.2.0.js"></script>
    <script src="/lib/js/jquery-1.11.1.js"></script>
    <script src="/lib/js/jquery-ui.js"></script>
    <script src="/lib/js/jquery.flot.js"></script>
    <script src="/lib/js/jquery.flot.categories.js"></script>
  </head>
  <body>
    <div id="status-bar">
      <div id="connected">Connected: 0</div>
      <div id="elapsed-time">Elapsed: </div>
      <div id="left-time">Left: </div>
    </div>
    <a id="previous">prev</a>
    <div id="present">html</div>
    <a id="next">next</a>

    <img id="question" src="/lib/img/question_answer.png" style="width: 5%;"></img>
    <img id="vote" src="/lib/img/vote.png"></img>
    <div id="number">0</div>
    <div id="candidates">
      <textarea id="content"></textarea>
    </div>
    <div id="vote-result">
      <div id="placeholder"></div>
    </div>
    <div id="questions">
      <a id="previous-question"></a>
      <div id="present-question"></div>
      <a id="next-question"></a>
      <button id="close-question">Close</button>
    
    </div>
    <div id="comment-bar">
    <div id="comment0"></div>
    <div id="comment1"></div>
    </div>
    <script>
    $(document).init(function(){
      if(!("WebSocket" in window))
      {
        alert("OOPS your browser does NOT support websocket, Phresent won't " +
              "work on this browser, please upgrade your browser or try " + 
              "another browser.\r\n\r\n" +
              "Your browser information:" + navigator.userAgent)
      }
    });
    
    var channel = io('/presenterChannel');
    var askSlide = 'load slide';

    var dialog;
    var locks = [false, false];

    var totalTime = 0;

    

    function submitCandidates() {
      var content = $("#content").val();
      channel.emit('create votes', content);
      $("#content").val("");
      dialog.dialog("close");
      //Have a dialog to show the vote result
      $("#vote-result").dialog({width:800, height:600});

    }

    dialog = $("#candidates").dialog({
      autoOpen: false,
      buttons: {
        "Submit": submitCandidates,
        Cancel: function() {
          $("#content").val("");
          dialog.dialog("close");


        }
      }
    });
    
    channel.on('show votes', function(votes){
      var dataForShown = new Array();
      for (var key in votes) {
        dataForShown.push([key, votes[key]]);
      }

      console.log(dataForShown);
      $.plot("#placeholder", [dataForShown], {
        series: {
          bars: {
            show: true,
            barWidth: 0.6,
            align: "center",
          },
        },
        xaxis: {
          mode: "categories",
          tickLength: 0,
        }
      });

    });

    $("#vote").on("click", function() {
      $("#candidates").dialog("open");
    });

    // Load questions


    $("#question").on("click", function() {
      console.log('questions!');
      $("#questions").dialog({width:800, height:600});
      channel.emit('load questions', 'LOAD');
    });

    // Load first page
    channel.emit('load presentation page');
    $("#previous").on("click", function() {
        channel.emit(askSlide, -1);
        return false;
    });

    $("#next").on("click", function() {
        channel.emit(askSlide, 1);
        return false;
    });

    channel.on(askSlide, function(content) {
        if (content != "THE END") {
            $('#present').html(content);
        }
    });

    channel.on('change question number', function(number) {
            $("#number").html(number.toString());
    });

    $("#previous-question").on('click', function () {
      channel.emit('load questions', 'PREVIOUS');
    });

    $("#next-question").on('click', function () {
      channel.emit('load questions', 'NEXT');
    });

    $("#close-question").on("click", function() {
      console.log('Send out!');
      channel.emit('load questions', 'REMOVE');
    });



    channel.on('show questions', function(question) {
      if (question == 'QUESTION END') {
        $("#questions").dialog("close");
      }
      else {
        $("#present-question").html("<h1>" + question + "</h1>");
      }
    });

    function unlock(number) {
      locks[number] = false;
      console.log("Unlock!");
    }

    function chooseCommentBar(){
      var result = locks.indexOf(false);
      if (result != -1) {
        locks[result] = true;
      }
      return result;
    }
    $("marquee").on("finish", function(){
      console.log("FInished!");
    });

    function showComment(comment){
      var choice = chooseCommentBar();
      if (choice == 0) {
        $("#comment" + choice.toString()).html("<font color='#ffffff' size='50px'><marquee bgcolor='#0000040' width='100%' loop='1'><strong>" + comment + "<strong></marquee></font>");
        setTimeout(function() {locks[choice]=false; console.log("reset" + choice.toString())}, 25000);
        console.log("1st comment");
        return choice;
      }
      else if (choice == 1) {
        $("#comment" + choice.toString()).html("<font color='#ffffff' size='50px'><marquee bgcolor='#0000040' width='100%' loop='1'><strong>" + comment + "<strong></marquee></font>");
        setTimeout(function() {locks[choice]=false; console.log("reset" + choice.toString())}, 25000);
        console.log("2nd comment");
        return choice;
      }
      else {
        setTimeout(function() {showComment(comment);}, 5000);
        return -1;
      }

    }
    channel.on('show comments', function(comment) {
      var result = showComment(comment);
      if (result == -1) {
          console.log('Wait!');
        //  setTimeout(function() { showComment(comment); }, 5000); 
      }
  //    else {
//        setTimeout(function() {locks[result]=false; console.log("reset" + result.toString())}, 25000);
    //  }
    });

    channel.on('update connected number', function(number) {
      $("#connected").html("Connected: " + number.toString());
    });

    channel.emit('total time');

    channel.on('update total time', function(sec){
      totalTime = sec;
    });

    function formatTime(number) {
      var time = "";
      var hour = Math.floor(number / 3600);
      var min = Math.floor(number / 60);
      min = min % 60;
      var sec = number - (hour * 3600) - (min * 60);
        time += hour.toString() + "h ";
        if (min < 10) {
          time += " ";
        }
        time += min.toString() + "m ";
        if (sec < 10) {
          time += " ";
        }
      time += sec.toString() + "s";
      return time;
    }

    channel.on('update elapsed time', function(number){
      var elapsedTime = formatTime(number);
      console.log(totalTime - number);
      var leftTime = formatTime(totalTime - number);
      console.log(leftTime);
      $("#elapsed-time").html("Elapsed: " + elapsedTime);
      $("#left-time").html("Left: " + leftTime)
    });
    </script>
  </body>
</html>
